<!DOCTYPE html><html class="default"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@matrixai/typescript-demo-lib</title><meta name="description" content="Documentation for @matrixai/typescript-demo-lib"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.body.classList.add(localStorage.getItem("tsd-theme") || "os")</script><header><div class="tsd-page-toolbar"><div class="container"><div class="table-wrap"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget search no-caption">Search</label><input type="text" id="tsd-search-field"/></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">@matrixai/typescript-demo-lib</a></div><div class="table-cell" id="tsd-widgets"><div id="tsd-filter"><a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a><div class="tsd-filter-group"><div class="tsd-select" id="tsd-filter-visibility"><span class="tsd-select-label">All</span><ul class="tsd-select-list"><li data-value="public">Public</li><li data-value="protected">Public/Protected</li><li data-value="private" class="selected">All</li></ul></div> <input type="checkbox" id="tsd-filter-inherited" checked/><label class="tsd-widget" for="tsd-filter-inherited">Inherited</label><input type="checkbox" id="tsd-filter-externals" checked/><label class="tsd-widget" for="tsd-filter-externals">Externals</label></div></div><a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a></div></div></div></div><div class="tsd-page-title"><div class="container"><h1>@matrixai/typescript-demo-lib </h1></div></div></header><div class="container container-main"><div class="row"><div class="col-8 col-content"><div class="tsd-panel tsd-typography">
<a href="#typescript-demo-lib" id="typescript-demo-lib" style="color: inherit; text-decoration: none;">
  <h1>TypeScript-Demo-Lib</h1>
</a>
<p><a href="https://gitlab.com/MatrixAI/open-source/TypeScript-Demo-Lib/commits/master"><img src="https://gitlab.com/MatrixAI/open-source/TypeScript-Demo-Lib/badges/master/pipeline.svg" alt="pipeline status"></a></p>

<a href="#installation" id="installation" style="color: inherit; text-decoration: none;">
  <h2>Installation</h2>
</a>
<p>Note that JavaScript libraries are not packaged in Nix. Only JavaScript applications are.</p>
<p>Building the package:</p>
<pre><code class="language-sh"><span class="hl-0">nix-build -E </span><span class="hl-1">&#39;(import ./pkgs.nix {}).callPackage ./default.nix {}&#39;</span>
</code></pre>
<p>Building the releases:</p>
<pre><code class="language-sh"><span class="hl-0">nix-build ./release.nix --attr application</span><br/><span class="hl-0">nix-build ./release.nix --attr docker</span>
</code></pre>
<p>Install into Nix user profile:</p>
<pre><code class="language-sh"><span class="hl-0">nix-env -f ./release.nix --install --attr application</span>
</code></pre>
<p>Install into Docker:</p>
<pre><code class="language-sh"><span class="hl-0">loaded=</span><span class="hl-1">&quot;$(docker load --input &quot;$(nix-build ./release.nix --attr docker)&quot;)&quot;</span><br/><span class="hl-0">image=</span><span class="hl-1">&quot;$(cut -d&#39; &#39; -f3 </span><span class="hl-0">&lt;&lt;&lt;</span><span class="hl-1"> &quot;$loaded&quot;)&quot;</span><br/><span class="hl-0">docker run -it </span><span class="hl-1">&quot;</span><span class="hl-2">$image</span><span class="hl-1">&quot;</span>
</code></pre>

<a href="#development" id="development" style="color: inherit; text-decoration: none;">
  <h2>Development</h2>
</a>
<p>Run <code>nix-shell</code>, and once you&#39;re inside, you can use:</p>
<pre><code class="language-sh"><span class="hl-3"># install (or reinstall packages from package.json)</span><br/><span class="hl-0">npm install</span><br/><span class="hl-3"># build the dist</span><br/><span class="hl-0">npm run build</span><br/><span class="hl-3"># run the repl (this allows you to import from ./src)</span><br/><span class="hl-0">npm run ts-node</span><br/><span class="hl-3"># run the tests</span><br/><span class="hl-0">npm run </span><span class="hl-4">test</span><br/><span class="hl-3"># lint the source code</span><br/><span class="hl-0">npm run lint</span><br/><span class="hl-3"># automatically fix the source</span><br/><span class="hl-0">npm run lintfix</span>
</code></pre>

<a href="#calling-executables" id="calling-executables" style="color: inherit; text-decoration: none;">
  <h3>Calling Executables</h3>
</a>
<p>When calling executables in development, use this style:</p>
<pre><code><span class="hl-2">npm</span><span class="hl-0"> </span><span class="hl-2">run</span><span class="hl-0"> </span><span class="hl-2">typescript</span><span class="hl-0">-</span><span class="hl-2">demo</span><span class="hl-0">-</span><span class="hl-2">lib</span><span class="hl-0"> -- </span><span class="hl-2">p1</span><span class="hl-0"> </span><span class="hl-2">p2</span><span class="hl-0"> </span><span class="hl-2">p3</span>
</code></pre>
<p>The <code>--</code> is necessary to make <code>npm</code> understand that the parameters are for your own executable, and not parameters to <code>npm</code>.</p>

<a href="#using-the-repl" id="using-the-repl" style="color: inherit; text-decoration: none;">
  <h3>Using the REPL</h3>
</a>
<pre><code><span class="hl-2">$</span><span class="hl-0"> </span><span class="hl-2">npm</span><span class="hl-0"> </span><span class="hl-2">run</span><span class="hl-0"> </span><span class="hl-2">ts</span><span class="hl-0">-</span><span class="hl-2">node</span><br/><span class="hl-0">&gt; </span><span class="hl-5">import</span><span class="hl-0"> </span><span class="hl-2">fs</span><span class="hl-0"> </span><span class="hl-5">from</span><span class="hl-0"> </span><span class="hl-1">&#39;fs&#39;</span><span class="hl-0">;</span><br/><span class="hl-0">&gt; </span><span class="hl-2">fs</span><br/><span class="hl-0">&gt; </span><span class="hl-5">import</span><span class="hl-0"> { </span><span class="hl-2">Library</span><span class="hl-0"> } </span><span class="hl-5">from</span><span class="hl-0"> </span><span class="hl-1">&#39;@&#39;</span><span class="hl-0">;</span><br/><span class="hl-0">&gt; </span><span class="hl-2">Library</span><br/><span class="hl-0">&gt; </span><span class="hl-5">import</span><span class="hl-0"> </span><span class="hl-2">Library</span><span class="hl-0"> </span><span class="hl-5">as</span><span class="hl-0"> </span><span class="hl-2">Library2</span><span class="hl-0"> </span><span class="hl-5">from</span><span class="hl-0"> </span><span class="hl-1">&#39;./src/lib/Library&#39;</span><span class="hl-0">;</span>
</code></pre>
<p>You can also create test files in <code>./src</code>, and run them with <code>npm run ts-node ./src/test.ts</code>.</p>
<p>This allows you to test individual pieces of typescript code, and it makes it easier when doing large scale architecting of TypeScript code.</p>

<a href="#path-aliases" id="path-aliases" style="color: inherit; text-decoration: none;">
  <h3>Path Aliases</h3>
</a>
<p>Due to <a href="https://github.com/microsoft/TypeScript/issues/10866">https://github.com/microsoft/TypeScript/issues/10866</a>, you cannot use path aliases without a bundler like Webpack to further transform the generated JavaScript code in order to resolve the path aliases. Because this is a simple library demonstration, there&#39;s no need to use a bundler. In fact, for such libraries, it is far more efficient to not bundle the code.</p>
<p>However, we have left the path alias configuration in <code>tsconfig.json</code>, <code>jest.config.js</code> and in the tests we are making use of the <code>@</code> alias.</p>

<a href="#local-package-linking" id="local-package-linking" style="color: inherit; text-decoration: none;">
  <h3>Local Package Linking</h3>
</a>
<p>When developing on multiple NPM packages, it can be easier to use <code>npm link</code> so that changes are immediately reflected rather than repeatedly publishing packages. To do this, you need to use <code>npm link</code>. After linking a local directory, you need to provide <code>tsconfig.json</code> paths so TypeScript compiler can find the right files.</p>
<p>For example when linking <code>@matrixai/db</code> located in <code>../js-db</code>:</p>
<pre><code class="language-sh"><span class="hl-0">npm link ../js-db</span>
</code></pre>
<p>You would need to add these paths to <code>tsconfig.json</code>:</p>
<pre><code><span class="hl-0">  </span><span class="hl-1">&quot;paths&quot;</span><span class="hl-0">: {</span><br/><span class="hl-0">    </span><span class="hl-1">&quot;@&quot;</span><span class="hl-2">:</span><span class="hl-0"> [</span><span class="hl-1">&quot;index&quot;</span><span class="hl-0">],</span><br/><span class="hl-0">    </span><span class="hl-1">&quot;@/*&quot;</span><span class="hl-2">:</span><span class="hl-0"> [</span><span class="hl-1">&quot;*&quot;</span><span class="hl-0">],</span><br/><span class="hl-0">    </span><span class="hl-1">&quot;@matrixai/db&quot;</span><span class="hl-2">:</span><span class="hl-0"> [</span><span class="hl-1">&quot;../node_modules/@matrixai/db/src&quot;</span><span class="hl-0">],</span><br/><span class="hl-0">    </span><span class="hl-1">&quot;@matrixai/db/*&quot;</span><span class="hl-2">:</span><span class="hl-0"> [</span><span class="hl-1">&quot;../node_modules/@matrixai/db/src/*&quot;</span><span class="hl-0">]</span><br/><span class="hl-0">  },</span>
</code></pre>

<a href="#native-module-toolchain" id="native-module-toolchain" style="color: inherit; text-decoration: none;">
  <h3>Native Module Toolchain</h3>
</a>
<p>There are some nuances when packaging with native modules.
Included native modules are level witch include leveldown and utp-native.</p>
<p>If a module is not set to public then pkg defaults to including it as bytecode.
To avoid this breaking with the <code>--no-bytecode</code> flag we need to add <code>--public-packages &quot;*&quot;</code></p>

<a href="#leveldown" id="leveldown" style="color: inherit; text-decoration: none;">
  <h4>leveldown</h4>
</a>
<p>To get leveldown to work with pkg we need to include the prebuilds with the executable.
after building with pkg you need to copy from <code>node_modules/leveldown/prebuilds</code> -&gt; <code>path_to_executable/prebuilds</code>
You only need to include the prebuilds for the arch you are targeting. e.g. for linux-x64 you need <code>prebuild/linux-x64</code>.</p>
<p>The folder structure for the executable should look like this.</p>
<ul>
<li>linux_executable_elf</li>
<li>prebuilds<ul>
<li>linux-x64<ul>
<li>(node files)</li>
</ul>
</li>
</ul>
</li>
</ul>

<a href="#utp-native" id="utp-native" style="color: inherit; text-decoration: none;">
  <h4>utp-native</h4>
</a>
<p>Including utp-native is simpler, you just need to add it as an asset for pkg.
Add the following lines to the package.json.</p>
<pre><code class="language-json"><span class="hl-1">&quot;pkg&quot;</span><span class="hl-0">: {</span><br/><span class="hl-0">    </span><span class="hl-6">&quot;assets&quot;</span><span class="hl-0">: </span><span class="hl-1">&quot;node_modules/utp-native/**/*&quot;</span><br/><span class="hl-0">  }</span>
</code></pre>

<a href="#threadsjs" id="threadsjs" style="color: inherit; text-decoration: none;">
  <h4>threads.js</h4>
</a>
<p>To make sure that the worker threads work properly you need to include the compiled worker scripts as an asset.
This can be fixed by adding the following to <code>package.json</code></p>
<pre><code class="language-json"><span class="hl-1">&quot;pkg&quot;</span><span class="hl-0">: {</span><br/><span class="hl-0">    </span><span class="hl-6">&quot;assets&quot;</span><span class="hl-0">: </span><span class="hl-1">&quot;dist/bin/worker.js&quot;</span><br/><span class="hl-0">  }</span>
</code></pre>
<p>If you need to include multiple assets then add them as an array.</p>
<pre><code class="language-json"><span class="hl-1">&quot;pkg&quot;</span><span class="hl-0">: {</span><br/><span class="hl-0">    </span><span class="hl-6">&quot;assets&quot;</span><span class="hl-0">: [</span><br/><span class="hl-0">      </span><span class="hl-1">&quot;node_modules/utp-native/**/*&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">&quot;dist/bin/worker.js&quot;</span><br/><span class="hl-0">    ]</span><br/><span class="hl-0">  }</span>
</code></pre>

<a href="#integration-into-nix" id="integration-into-nix" style="color: inherit; text-decoration: none;">
  <h4>Integration into Nix</h4>
</a>
<p>Nix build uses node2nix to create the dependencies of the node modules. this does a fairly good job of detecting dependencies but with native modules it may fail to detect CLI tools like <code>node-gyp-build</code>.</p>
<p>To ensure the proper dependencies exist while building we need to bring in these utilities during the build:</p>
<pre><code><span class="hl-2">buildInputs</span><span class="hl-0"> = </span><span class="hl-2">attrs</span><span class="hl-0">.</span><span class="hl-2">buildInputs</span><span class="hl-0"> ++ [ </span><span class="hl-2">nodePackages</span><span class="hl-0">.</span><span class="hl-2">node</span><span class="hl-0">-</span><span class="hl-2">gyp</span><span class="hl-0">-</span><span class="hl-2">build</span><span class="hl-0"> ];</span>
</code></pre>
<p>This has to be done to both <code>node2nixProd</code> and <code>node2nixDev</code>.</p>

<a href="#docs-generation" id="docs-generation" style="color: inherit; text-decoration: none;">
  <h3>Docs Generation</h3>
</a>
<pre><code class="language-sh"><span class="hl-0">npm run docs</span>
</code></pre>
<p>See the docs at: <a href="https://matrixai.github.io/TypeScript-Demo-Lib/">https://matrixai.github.io/TypeScript-Demo-Lib/</a></p>

<a href="#publishing" id="publishing" style="color: inherit; text-decoration: none;">
  <h3>Publishing</h3>
</a>
<pre><code class="language-sh"><span class="hl-3"># npm login</span><br/><span class="hl-0">npm version patch </span><span class="hl-3"># major/minor/patch</span><br/><span class="hl-0">npm run build</span><br/><span class="hl-0">npm publish --access public</span><br/><span class="hl-0">git push</span><br/><span class="hl-0">git push --tags</span>
</code></pre>
</div></div><div class="col-4 col-menu menu-sticky-wrap menu-highlight"><nav class="tsd-navigation primary"><ul><li class="current"><a href="modules.html">Exports</a></li></ul></nav><nav class="tsd-navigation secondary menu-sticky"><ul><li class="tsd-kind-class"><a href="classes/Library.html" class="tsd-kind-icon">Library</a></li></ul></nav></div></div></div><footer class="with-border-bottom"><div class="container"><h2>Legend</h2><div class="tsd-legend-group"><ul class="tsd-legend"><li class="tsd-kind-constructor tsd-parent-kind-class"><span class="tsd-kind-icon">Constructor</span></li><li class="tsd-kind-property tsd-parent-kind-class"><span class="tsd-kind-icon">Property</span></li></ul></div><h2>Settings</h2><p>Theme <select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></p></div></footer><div class="container tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div><script src="assets/main.js"></script></body></html>